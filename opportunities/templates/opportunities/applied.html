{% extends "opportunities/base.html" %}

{% block title %}Applied Opportunities - RFP Queen{% endblock %}

{% block content %}
<div id="applied-root"></div>

<script>
(function(){
  const root = document.getElementById("applied-root");
  const state = { items: [], shown: 0, pageSize: 20, email: "", loading: true };

  function show(html){ root.innerHTML = html; }
  function status(msg){ show(`<div class="container"><div style="padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">${msg}</div></div>`); }

  function card(o){
    const urgency = o.close_date ? (new Date(o.close_date) - new Date() < 30*86400000 ? "urgent" : "soon") : "ongoing";
    const urgencyColor = urgency === "urgent" ? "#dc2626" : urgency === "soon" ? "#f59e0b" : "#6b7280";
    
    return `
      <div style="border:1px solid #e5e7eb;border-radius:14px;padding:20px;margin:12px 0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
          <span style="font-size:.75rem;padding:4px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;text-transform:uppercase">${o.collection||"applied"}</span>
          <span style="font-size:.75rem;padding:4px 8px;border:1px solid ${urgencyColor};border-radius:8px;background:${urgency === "urgent" ? "#fee2e2" : urgency === "soon" ? "#fef3c7" : "#f9fafb"};color:${urgencyColor};font-weight:600">${urgency}</span>
          <span style="font-size:.75rem;padding:4px 8px;border:1px solid #10b981;border-radius:8px;background:#d1fae5;color:#065f46;font-weight:600">Applied</span>
        </div>
        <div style="font-weight:600;font-size:1.25rem;margin-bottom:6px;color:#111827">${o.title||"Untitled"}</div>
        <div style="color:#6b7280;margin-bottom:8px;font-weight:500">${o.agency||o.department||"Unknown Agency"}</div>
        <div style="color:#374151;font-size:0.9rem;line-height:1.6;margin-bottom:12px">
          ${o.description ? (o.description.length > 200 ? o.description.substring(0, 200) + "..." : o.description) : ""}
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:8px;margin-bottom:12px;font-size:0.85rem;color:#6b7280">
          <div><strong>Applied:</strong> ${o.applied_at ? new Date(o.applied_at).toLocaleDateString() : "—"}</div>
          <div><strong>Deadline:</strong> ${o.close_date ? new Date(o.close_date).toLocaleDateString() : "—"}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          ${o.application_url ? 
            `<a href="${o.application_url}" target="_blank" style="padding:10px 16px;border:0;border-radius:10px;background:#685bc6;color:#fff;font-weight:600;text-decoration:none;cursor:pointer;flex:1;min-width:150px;text-align:center">
              Open Application
            </a>` : ""}
          ${o.url ? `<a href="${o.url}" target="_blank" style="padding:10px 16px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#111827;font-weight:600;text-decoration:none;cursor:pointer;flex:1;min-width:150px;text-align:center">View Details</a>` : ""}
        </div>
      </div>`;
  }

  function render(items){
    const bar = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;padding:12px 0;margin-bottom:20px">
        <div style="color:#6b7280"><strong>Applied Opportunities</strong> • Signed in as ${state.email||""}</div>
        <div style="display:flex;gap:8px">
          <a href="/explore/" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#111827;text-decoration:none">Explore</a>
          <a href="/saved/" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#111827;text-decoration:none">Saved</a>
          <button id="signoutBtn" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer">Sign out</button>
        </div>
      </div>`;
    
    const haveMore = state.shown < items.length;
    const list = items.slice(0, state.shown).map(card).join("") || 
      "<p style='text-align:center;color:#6b7280;padding:40px'>No applied opportunities yet. <a href='/explore/' style='color:#685bc6'>Explore opportunities</a> to get started.</p>";
    
    show(`<div class="container">
      ${bar}
      ${items.length > 0 ? `<div style="margin:16px 0;color:#6b7280;font-size:0.9rem">${items.length} applied opportunity${items.length !== 1 ? 'ies' : 'y'}</div>` : ""}
      ${list}
      ${haveMore ? `<div style="text-align:center;margin:20px 0 30px;"><button id="load-more" style="padding:12px 20px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-weight:600">Load more</button></div>` : ""}
    </div>`);

    const so = document.getElementById("signoutBtn");
    if (so) so.onclick = async ()=>{ try{ await auth.signOut(); location.reload(); }catch(e){ console.error(e); } };

    const lm = document.getElementById("load-more");
    if (lm) lm.onclick = ()=>{ state.shown = Math.min(items.length, state.shown + state.pageSize); render(state.items); };
  }

  async function loadApplied(){
    try {
      const result = await window.api.call('/api/applications/', 'GET', { 
        firebase_uid: window.appState.firebaseUid 
      });
      state.items = result.applications || [];
      state.shown = Math.min(state.pageSize, state.items.length);
      render(state.items);
      state.loading = false;
    } catch (e) {
      status("Error loading applied opportunities: " + e.message);
      state.loading = false;
    }
  }

  (async function boot(){
    status("Loading...");
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ location.href = '/'; return; }
      state.email = user.email || "";
      window.appState.user = user;
      window.appState.firebaseUid = user.uid;
      await loadApplied();
    });
  })();
})();
</script>
{% endblock %}
