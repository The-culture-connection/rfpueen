<div id="dashboard-applied-root" style="min-height:160px;font-family:Inter,system-ui,Arial,sans-serif"></div>

<script>
(function(){
  const root = document.getElementById("dashboard-applied-root");
  const state = { 
    items: [], 
    shown: 0, 
    pageSize: 20, 
    email: "",
    loading: true
  };

  function show(html){
    root.innerHTML = html;
  }

  function showError(msg, details = null) {
    const errorMsg = details ? `${msg}\n\nDetails: ${details}` : msg;
    const errorHtml = `
      <div id="error-banner" style="max-width:960px;margin:16px auto;padding:16px;border:2px solid #dc2626;border-radius:12px;background:#fee2e2;color:#991b1b;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
        <div style="display:flex;align-items:start;gap:12px">
          <div style="font-size:1.5rem;line-height:1">⚠️</div>
          <div style="flex:1">
            <strong style="font-size:1.1rem;display:block;margin-bottom:6px">Error</strong>
            <div style="line-height:1.6;white-space:pre-wrap">${errorMsg}</div>
            <button onclick="document.getElementById('error-banner').style.display='none'" style="margin-top:12px;padding:6px 12px;border:1px solid #991b1b;border-radius:6px;background:#fff;color:#991b1b;cursor:pointer;font-weight:600">Dismiss</button>
          </div>
        </div>
      </div>`;
    const currentHtml = root.innerHTML.replace(/<div id="error-banner"[^>]*>[\s\S]*?<\/div>/gi, '');
    root.innerHTML = errorHtml + currentHtml;
  }

  function showInfo(msg, type = "info") {
    const colors = {
      info: { bg: "#dbeafe", border: "#3b82f6", text: "#1e40af", icon: "ℹ️" },
      success: { bg: "#d1fae5", border: "#10b981", text: "#065f46", icon: "✅" },
      warning: { bg: "#fef3c7", border: "#f59e0b", text: "#92400e", icon: "⚠️" }
    };
    const c = colors[type] || colors.info;
    const infoHtml = `
      <div id="info-banner" style="max-width:960px;margin:16px auto;padding:16px;border:2px solid ${c.border};border-radius:12px;background:${c.bg};color:${c.text};box-shadow:0 2px 4px rgba(0,0,0,0.1)">
        <div style="display:flex;align-items:start;gap:12px">
          <div style="font-size:1.5rem;line-height:1">${c.icon}</div>
          <div style="flex:1">
            <div style="line-height:1.6;white-space:pre-wrap">${msg}</div>
            <button onclick="document.getElementById('info-banner').style.display='none'" style="margin-top:12px;padding:6px 12px;border:1px solid ${c.border};border-radius:6px;background:#fff;color:${c.text};cursor:pointer;font-weight:600">Dismiss</button>
          </div>
        </div>
      </div>`;
    const currentHtml = root.innerHTML.replace(/<div id="info-banner"[^>]*>[\s\S]*?<\/div>/gi, '');
    root.innerHTML = infoHtml + currentHtml;
  }

  function status(msg){
    show(`<div style="max-width:960px;margin:20px auto;padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff">${msg}</div>`);
  }

  function parseDate(s){
    if(!s) return null;
    try{
      const d = new Date(/^\d{4}-\d{2}-\d{2}/.test(s)? s.slice(0,10) : s);
      return isNaN(+d) ? null : d;
    }catch{ return null; }
  }

  function bucketOf(deadline){
    const d = parseDate(deadline); if(!d) return "ongoing";
    const days = Math.ceil((d - new Date())/86400000);
    if (days <= 30) return "urgent";
    if (days <= 92) return "soon";
    return "ongoing";
  }

  // Opportunity card
  function card(o, index){
    const due = o.closeDate || o.deadline;
    const urgency = bucketOf(due);
    const urgencyColor = urgency === "urgent" ? "#dc2626" : urgency === "soon" ? "#f59e0b" : "#6b7280";
    const appliedDate = o.appliedAt ? (o.appliedAt.toDate ? o.appliedAt.toDate() : new Date(o.appliedAt)) : null;
    
    return `
      <div style="border:1px solid #e5e7eb;border-radius:14px;padding:20px;margin:12px 0;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
          <span style="font-size:.75rem;padding:4px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;text-transform:uppercase">${o.collection||"applied"}</span>
          <span style="font-size:.75rem;padding:4px 8px;border:1px solid ${urgencyColor};border-radius:8px;background:${urgency === "urgent" ? "#fee2e2" : urgency === "soon" ? "#fef3c7" : "#f9fafb"};color:${urgencyColor};font-weight:600">${urgency}</span>
          <span style="font-size:.75rem;padding:4px 8px;border:1px solid #10b981;border-radius:8px;background:#d1fae5;color:#065f46;font-weight:600">Applied</span>
        </div>
        <div style="font-weight:600;font-size:1.25rem;margin-bottom:6px;color:#111827">${o.title||"Untitled Opportunity"}</div>
        <div style="color:#6b7280;margin-bottom:8px;font-weight:500">${o.agency||o.department||"Unknown Agency"}</div>
        <div style="color:#374151;font-size:0.9rem;line-height:1.6;margin-bottom:12px">
          ${o.description ? (o.description.length > 200 ? o.description.substring(0, 200) + "..." : o.description) : (o.summary || "")}
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:8px;margin-bottom:12px;font-size:0.85rem;color:#6b7280">
          <div><strong>Applied:</strong> ${appliedDate ? appliedDate.toLocaleDateString() : "—"}</div>
          <div><strong>Deadline:</strong> ${due ? new Date(due).toLocaleDateString() : "—"}</div>
          <div><strong>Location:</strong> ${o.place || [o.city, o.state].filter(Boolean).join(", ") || "—"}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          ${o.applicationUrl ? 
            `<a href="${o.applicationUrl}" target="_blank" style="padding:10px 16px;border:0;border-radius:10px;background:#685bc6;color:#fff;font-weight:600;text-decoration:none;cursor:pointer;flex:1;min-width:100px;text-align:center">
              Open Application Form
            </a>` : 
            `<button onclick="showInstructions(${index})" style="padding:10px 16px;border:1px solid #685bc6;border-radius:10px;background:#fff;color:#685bc6;font-weight:600;cursor:pointer;flex:1;min-width:100px">
              View Instructions
            </button>`
          }
          <a href="${o.url||o.synopsisUrl||o.link||"#"}" target="_blank" style="padding:10px 16px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#111827;font-weight:600;text-decoration:none;cursor:pointer;flex:1;min-width:100px;text-align:center">
            View Details
          </a>
          <button onclick="removeApplied('${o.opportunityId || o.id}', ${index})" style="padding:10px 16px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#dc2626;font-weight:600;cursor:pointer;flex:1;min-width:100px">
            Remove
          </button>
        </div>
      </div>`;
  }

  window.showInstructions = function(index) {
    const opp = state.items[index];
    if (!opp) return;
    
    const instructions = opp.applicationInstructions || "Check the opportunity page for application details.";
    const modal = `
      <div id="app-modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px">
        <div style="background:#fff;border-radius:14px;padding:24px;max-width:600px;width:100%;max-height:80vh;overflow:auto">
          <h2 style="margin:0 0 12px">Application Instructions</h2>
          <h3 style="margin:0 0 8px;font-size:1.1rem">${opp.title || "Opportunity"}</h3>
          <div style="white-space:pre-line;line-height:1.6;color:#374151;margin-bottom:16px;padding:12px;background:#f9fafb;border-radius:8px">${instructions}</div>
          ${opp.url ? `<div style="margin-bottom:16px"><a href="${opp.url}" target="_blank" style="color:#685bc6;text-decoration:none;font-weight:600">View Opportunity Page →</a></div>` : ""}
          <button onclick="document.getElementById('app-modal').remove()" 
                  style="padding:10px 20px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer;width:100%">
            Close
          </button>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', modal);
  };

  window.removeApplied = async function(oppId, index) {
    if (!confirm("Remove this opportunity from your applied list?")) return;
    
    try {
      const user = firebase.auth().currentUser;
      if (!user) {
        showError("You must be signed in to remove opportunities.\n\nPlease sign in and try again.");
        return;
      }
      const db = firebase.firestore();

      try {
        await db.collection("profiles").doc(user.uid).collection("Applied").doc(oppId).delete();
      } catch (e) {
        if (e.code === "permission-denied") {
          throw new Error("Permission denied. You don't have write access to your profile data.\n\nPlease check your Firebase security rules.");
        } else if (e.code === "unavailable") {
          throw new Error("Firebase service is temporarily unavailable.\n\nPlease check your internet connection and try again.");
        } else {
          throw new Error(`Failed to remove opportunity: ${e.message || "Unknown error"}\n\nPlease try again or contact support if the issue persists.`);
        }
      }

      state.items.splice(index, 1);
      state.shown = Math.min(state.shown, state.items.length);
      render(state.items);
      showInfo("Opportunity removed from your applied list.", "success");
    } catch (e) {
      showError("Failed to remove opportunity", e.message || e.toString());
    }
  };

  function render(items){
    const bar = `
      <div style="max-width:960px;margin:8px auto 0;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;padding:12px 0">
        <div style="color:#6b7280">
          <strong>Applied Opportunities</strong> • Signed in as ${state.email||""}
        </div>
        <div style="display:flex;gap:8px">
          <a href="/explore" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#111827;text-decoration:none;cursor:pointer">Explore</a>
          <a href="/dashboard-saved" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#111827;text-decoration:none;cursor:pointer">Saved</a>
          <button id="signoutBtn" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer">Sign out</button>
        </div>
      </div>`;
    
    const haveMore = state.shown < items.length;
    const list = items.slice(0, state.shown).map((o, i) => card(o, i)).join("") || 
      "<p style='max-width:960px;margin:14px auto;text-align:center;color:#6b7280;padding:40px'>No applied opportunities yet. <a href='/explore' style='color:#685bc6'>Explore opportunities</a> to get started.</p>";
    
    show(`${bar}
      <div style="max-width:960px;margin:14px auto;">
        ${items.length > 0 ? `<div style="margin:16px 0;color:#6b7280;font-size:0.9rem">${items.length} applied opportunity${items.length !== 1 ? 'ies' : 'y'}</div>` : ""}
        ${list}
        ${haveMore ? `<div style="text-align:center;margin:20px 0 30px;">
          <button id="cc-load-more" style="padding:12px 20px;border:1px solid #d1d5db;border-radius:10px;background:#fff;cursor:pointer;font-weight:600">Load more</button>
        </div>` : ""}
      </div>`);

    const so = document.getElementById("signoutBtn");
    if (so) so.onclick = async ()=>{ try{ await firebase.auth().signOut(); location.reload(); }catch(e){ console.error(e); } };

    const lm = document.getElementById("cc-load-more");
    if (lm) lm.onclick = ()=>{ state.shown = Math.min(items.length, state.shown + state.pageSize); render(state.items); };
  }

  async function loadApplied(){
    try {
      const user = firebase.auth().currentUser;
      if (!user) {
        throw new Error("You must be signed in to view applied opportunities.\n\nPlease sign in and try again.");
      }
      const db = firebase.firestore();

      let snap;
      try {
        snap = await db.collection("profiles").doc(user.uid).collection("Applied")
          .orderBy("appliedAt", "desc")
          .limit(100)
          .get();
      } catch (e) {
        if (e.code === "permission-denied") {
          throw new Error("Permission denied. You don't have read access to your profile data.\n\nPlease check your Firebase security rules or contact support.");
        } else if (e.code === "unavailable") {
          throw new Error("Firebase service is temporarily unavailable.\n\nPlease check your internet connection and try again.");
        } else if (e.code === "failed-precondition") {
          throw new Error("Firestore index required.\n\nPlease create an index for 'appliedAt' in the Applied collection, or contact support.");
        } else {
          throw new Error(`Failed to load applied opportunities: ${e.message || "Unknown error"}\n\nPlease try again or contact support if the issue persists.`);
        }
      }

      state.items = snap.docs.map(d => {
        try {
          return { id: d.id, ...d.data() };
        } catch (e) {
          console.error("Error parsing document:", d.id, e);
          return null;
        }
      }).filter(Boolean);

      state.shown = Math.min(state.pageSize, state.items.length);
      render(state.items);
      state.loading = false;

      if (state.items.length === 0) {
        showInfo("You haven't applied to any opportunities yet.\n\nExplore opportunities to find ones that match your profile.", "info");
      }
    } catch (e) {
      showError("Failed to load applied opportunities", e.message || e.toString());
      state.loading = false;
      render([]);
    }
  }

  // Boot
  (async function boot(){
    status("Loading...");
    function add(src){ return new Promise((res,rej)=>{ const s=document.createElement("script"); s.src=src; s.onload=res; s.onerror=()=>rej(new Error("Failed to load "+src)); document.head.appendChild(s); }); }
    
    try{
      await add("https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js");
      await add("https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js");
      await add("https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js");
    }catch(e){ return show(`<p style="color:#b91c1c">Script load error: ${e.message}</p>`); }

    const cfg = {
      apiKey: "AIzaSyDbkrUWV13zBvl4L2lu5Qw5aLYbC9LCjJk",
      authDomain: "therfpqueen.firebaseapp.com",
      projectId: "therfpqueen-f11fd"
    };

    try{
      firebase.initializeApp(cfg);
      const auth = firebase.auth();

      auth.onAuthStateChanged(async (user)=>{
        if(!user){
          show(`
            <div style="max-width:420px;margin:40px auto;padding:20px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;">
              <h3 style="margin:0 0 8px;">Sign in</h3>
              <div id="err" style="display:none;margin-bottom:10px;color:#b91c1c;"></div>
              <input id="email" type="email" placeholder="Email" autocomplete="email"
                     style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px;margin-bottom:8px;">
              <input id="password" type="password" placeholder="Password" autocomplete="current-password"
                     style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:10px;margin-bottom:12px;">
              <button id="loginBtn" style="width:100%;padding:12px;border:0;border-radius:12px;background:#685bc6;color:#fff;font-weight:600;cursor:pointer">
                Log in
              </button>
            </div>`);
          const lb = document.getElementById("loginBtn");
          lb.onclick = async ()=>{
            const err = document.getElementById("err");
            err.style.display="none";
            try {
              const email = document.getElementById("email").value.trim();
              const pw = document.getElementById("password").value;
              await auth.signInWithEmailAndPassword(email,pw);
            } catch(e){
              let errorMsg = "Login failed";
              if (e.code === "auth/user-not-found") {
                errorMsg = "No account found with this email address.\n\nPlease check your email or sign up for a new account.";
              } else if (e.code === "auth/wrong-password") {
                errorMsg = "Incorrect password.\n\nPlease check your password and try again.";
              } else if (e.code === "auth/invalid-email") {
                errorMsg = "Invalid email address format.\n\nPlease enter a valid email address.";
              } else if (e.code === "auth/too-many-requests") {
                errorMsg = "Too many failed login attempts.\n\nPlease try again later or reset your password.";
              } else if (e.code === "auth/network-request-failed") {
                errorMsg = "Network error. Please check your internet connection and try again.";
              } else {
                errorMsg = (e?.message || "Login failed").replace("Firebase:","").replace("auth/", "").trim();
              }
              err.textContent = errorMsg;
              err.style.display = "block";
            }
          };
          return;
        }

        state.email = user.email || "";
        await loadApplied();
      });
    }catch(e){
      const errorMsg = e.message || "Unknown error";
      show(`<div style="max-width:960px;margin:20px auto;padding:16px;border:2px solid #dc2626;border-radius:12px;background:#fee2e2;color:#991b1b">
        <strong>Failed to initialize Firebase</strong><br>
        Error: ${errorMsg}<br><br>
        Possible causes:<br>
        - Firebase configuration is incorrect<br>
        - Network connectivity issues<br>
        - Scripts failed to load<br><br>
        Please refresh the page or contact support if the issue persists.
      </div>`);
    }
  })();
})();
</script>
