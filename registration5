<!-- ===== REGISTRATION 5 (Safe Mode) ===== -->
<div id="reg5" style="max-width:980px;margin:40px auto;padding:24px;border:1px solid #e5e7eb;border-radius:14px;font-family:Inter,system-ui,Arial,sans-serif;display:none">
  <h2 style="margin:0 0 12px;">Organization Profile</h2>
  <p style="margin:0 0 18px;color:#6b7280">Minimal view loaded. You can save & continue to your dashboard.</p>

  <style>
    .pill{padding:8px 12px;border:1px solid #cbd5e1;border-radius:999px;background:#fff;cursor:pointer}
    .pill.active{background:#111827;color:#fff;border-color:#111827}
  </style>

  <h3 style="margin:16px 0 8px;">Entity type</h3>
  <div id="cc-entity-type" style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px">
    <button class="pill" data-val="nonprofit">Nonprofit</button>
    <button class="pill" data-val="LLC">LLC</button>
    <button class="pill" data-val="C-corp">C-corp</button>
    <button class="pill" data-val="B-corp">B-corp</button>
    <button class="pill" data-val="sole proprietorship">Sole proprietorship</button>
    <button class="pill" data-val="student group">Student group</button>
  </div>
  <input id="cc-entity-selected" type="hidden">

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:22px">
    <button id="cc-save" style="padding:12px 16px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer">Save progress</button>
    <button id="cc-continue" style="padding:12px 16px;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer">Continue</button>
    <small id="cc-status" style="align-self:center;color:#6b7280">Minimal form loaded.</small>
  </div>
</div>

<div id="reg5-guard" style="max-width:980px;margin:20px auto;padding:12px;border:1px solid #e5e7eb;border-radius:10px;color:#6b7280;font-family:Inter,system-ui,Arial,sans-serif;display:none">
  You need to sign in. <a href="/signin">Go to sign in</a>
  <div id="boot-error" style="margin-top:8px;color:#b91c1c;white-space:pre-wrap;display:none"></div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
(function(){
  const DASHBOARD_URL = "https://www.the-culture-connection.com/dashboard";

  // Loud error surface
  function showErr(msg){
    const guard = document.getElementById("reg5-guard");
    const box = document.getElementById("boot-error") || (function(){
      const d=document.createElement("div");
      d.id="boot-error";
      d.style.cssText="margin-top:8px;color:#b91c1c;white-space:pre-wrap";
      guard && guard.appendChild(d);
      return d;
    })();
    if (box) { box.style.display="block"; box.textContent=String(msg); }
  }
  window.addEventListener("error", e => showErr("Script error: " + (e?.message || e)));
  window.addEventListener("unhandledrejection", e => showErr("Promise error: " + (e?.reason?.message || e?.reason || e)));

  const wrap = document.getElementById("reg5");
  const guard = document.getElementById("reg5-guard");
  const pillWrap = document.getElementById("cc-entity-type");
  const entitySelected = document.getElementById("cc-entity-selected");
  const statusEl = document.getElementById("cc-status");
  const saveBtn = document.getElementById("cc-save");
  const contBtn = document.getElementById("cc-continue");

  function setStatus(msg, bad){ if(statusEl){ statusEl.textContent=msg; statusEl.style.color = bad?"#b91c1c":"#6b7280"; } }

  // Basic UI wiring (works even without Firebase)
  if (pillWrap) {
    pillWrap.addEventListener("click", (e)=>{
      const b = e.target.closest(".pill"); if(!b) return;
      [...pillWrap.querySelectorAll(".pill")].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      entitySelected.value = b.dataset.val || "";
    });
  }

  // Show guard until auth decides
  guard.style.display = "block";
  wrap.style.display  = "none";

  // Init Firebase
  const cfg = {
    apiKey: "AIzaSyDbkrUWV13zBvl4L2lu5Qw5aLYbC9LCjJk",
    authDomain: "therfpqueen-f11fd.firebaseapp.com",
    projectId: "therfpqueen-f11fd",
    storageBucket: "therfpqueen-f11fd.firebasestorage.app",
    messagingSenderId: "173138212955",
    appId: "1:173138212955:web:2753c72dc7be65cf14677e",
    measurementId: "G-83PDWFH42F"
  };
  try {
    if (!firebase.apps.length) firebase.initializeApp(cfg);
  } catch (e) {
    showErr("Firebase init error: " + (e && e.message ? e.message : e));
    return;
  }
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Auth state → toggle UI + prefill entityType
  auth.onAuthStateChanged(async (user)=>{
    if (!user) {
      guard.style.display = "block";
      wrap.style.display  = "none";
      return;
    }
    guard.style.display = "none";
    wrap.style.display  = "block";

    try {
      const snap = await db.collection("profiles").doc(user.uid).get();
      if (snap.exists) {
        const d = snap.data() || {};
        if (d.entityType) {
          entitySelected.value = d.entityType;
          const btn = [...(pillWrap?.querySelectorAll(".pill")||[])].find(p=>p.dataset.val===d.entityType);
          if (btn) btn.classList.add("active");
        }
      }
    } catch (e) {
      setStatus("Prefill error (continuing)…", true);
      console.warn(e);
    }
  });

  async function saveAll(advance){
    const user = (auth && auth.currentUser) || null;
    if (!user) { window.location.assign("/signin"); return; }
    try {
      setStatus("Saving…");
      const data = { entityType: entitySelected.value || null, onboardingStep: 6, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
      await db.collection("profiles").doc(user.uid).set(data, { merge:true });
      if (advance) {
        // Use replace() to avoid back button loop
        window.top.location.replace(DASHBOARD_URL);
      } else {
        setStatus("Saved.");
      }
    } catch (e) {
      console.error(e);
      setStatus("Save failed.", true);
      showErr(e?.message || e);
    }
  }

  saveBtn && saveBtn.addEventListener("click", ()=>saveAll(false));
  contBtn && contBtn.addEventListener("click", ()=>saveAll(true));
})();
</script>
